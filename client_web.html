<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C·ªù T∆∞·ªõng Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
  <style>
    /* === CSS BODY === */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-image: url('/static/landing_bg.jpg');
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
      background-color: #3d2c1f;
      margin: 0;
      padding: 20px;
      color: #e0d6c5;
      font-size: 16px;
      min-height: 100vh;
      transition: background-image 0.5s ease-in-out;
      box-sizing: border-box;
    }
    body.in-lobby {
      background-image: url('/static/Sanhcho.jpg');
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
    }

    header { display: none; }
    h2, h3 { font-family: 'Noto Serif SC', serif; color: #8b0000; border-bottom: 1px solid #dcd1bb; padding-bottom: 5px; }

    #lobbyView, .right, #modalContent {
      background: #fdfbf5; color: #3d2c1f;
      border-radius: 12px; padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border: 1px solid #dcd1bb;
    }

    #loginView {
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      height: 90vh; max-width: 1100px; margin: 0 auto;
      text-align: center; padding: 20px; background: transparent;
      border: none; box-shadow: none;
    }
    #loginView input {
      font-size: 1.2em; padding: 14px 20px; border-radius: 10px;
      border: 2px solid #7a4f2b; background: rgba(255,255,255,0.9);
      margin-top: 220px; width: 320px; max-width: 90%; text-align: center; color: #3d2c1f;
    }
    #loginView button {
      font-family: 'Noto Serif SC', serif; font-size: 1.7em;
      padding: 14px 45px; background: rgb(134,18,18); color: white;
      border: 2px solid #ffc; margin-top: 25px; cursor: pointer;
      border-radius: 10px; text-transform: uppercase; font-weight: 700;
      box-shadow: 0 5px 15px rgba(109,11,11,0.4);
    }
    #loginView button:hover { background: #c00; transform: translateY(-2px); }

    #lobbyView { display: none; max-width: 600px; margin: 20px auto; }
    #gameView { display: none; }

    .layout { display:flex; gap:20px; justify-content:center; margin-top:10px; flex-wrap:wrap; position:relative; z-index:1; }
    .left { width: 660px; }
    .right { width:300px; padding:16px; box-sizing:border-box; }

    button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:15px; transition:background-color 0.2s, transform 0.1s; }
    button:hover { transform:translateY(-1px); }
    button:disabled { background:#ccc!important; color:#666; cursor:not-allowed; }

    .controls button, .lobby-controls button { background:#8b0000; color:white; margin-left:8px; }
    .controls button:hover, .lobby-controls button:hover { background:#a52a2a; }

    .board {
      display:grid;
      grid-template-columns:repeat(9,70px);
      grid-template-rows:repeat(10,70px);
      width:630px; height:700px;
      background-image:url('/static/banco.jpg');
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      border-radius:10px;
      border:6px solid #7a4f2b;
      box-shadow:0 8px 24px rgba(0,0,0,0.25);
      position:relative; margin:20px auto; justify-content:center; align-content:center;
      transition:transform 0.5s;
    }
    .cell { width:70px; height:70px; display:flex; justify-content:center; align-items:center; cursor:pointer; }

    .piece { width:60px; height:60px; border-radius:50%; font-family:'Noto Serif SC', serif; font-weight:900; font-size:32px; display:flex; justify-content:center; align-items:center;
      background:linear-gradient(145deg,#f0e0c0,#d8b888); border:5px solid #8b5a2b; }
    .piece--red { color:#c00; }
    .piece--black { color:#333; }

    .board--flipped { transform:rotate(180deg); }
    .board--flipped .piece { transform:rotate(-180deg); }

    #modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; }
    #modalContent { text-align:center; width:400px; }
  </style>
</head>
<body>

  <div id="loginView">
    <input id="player" value="Player1" placeholder="T√™n ng∆∞·ªùi ch∆°i" />
    <button onclick="connect()">CH∆†I NGAY</button>
  </div>

  <div id="lobbyView">
    <h2>S·∫£nh ch·ªù</h2>
    <p>Ch√†o <b id="lobbyPlayerName"></b>.</p>
    <div class="lobby-controls">
      <button onclick="challengeBot()">Ch∆°i v·ªõi m√°y (Bot)</button>
    </div>
    <div id="invitations"></div>
    <h3>Ng∆∞·ªùi ch∆°i online</h3>
    <ul id="playerList"><li>ƒêang t·∫£i...</li></ul>
  </div>

  <div id="gameView">
    <div class="layout">
      <div class="left">
        <div class="game-info">
          <div class="status" id="status">ƒêang ch·ªù...</div>
          <div class="timer red" id="clock_red">üî¥ ƒê·ªè: 05:00</div>
          <div class="timer black" id="clock_black">‚ö´ ƒêen: 05:00</div>
          <div class="controls">
            <button onclick="leaveGame()">V·ªÅ S·∫£nh</button>
          </div>
        </div>
        <div class="board" id="board"></div>
      </div>
      <div class="right">
        <h3>L·ªãch s·ª≠ / H·ªá th·ªëng</h3>
        <div id="log"></div>
        <h3>Chat</h3>
        <div id="chatLog"></div>
        <div class="chat-input-area">
          <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
          <button id="sendChatBtn">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalOverlay">
    <div id="modalContent">
      <h2 id="modalTitle">Tr·∫≠n ƒë·∫•u k·∫øt th√∫c!</h2>
      <h1 id="modalWinnerName">Player1 Th·∫Øng!</h1>
      <p id="modalText">L√Ω do: T∆∞·ªõng ƒë√£ b·ªã ƒÉn</p>
      <div id="modalActions">
        <button onclick="offerRematch()">Ch∆°i l·∫°i</button>
        <button onclick="leaveGame()">V·ªÅ S·∫£nh</button>
      </div>
    </div>
  </div>

<script>
  let ws = null, playerName = null, myColor = null;
  let clocks = { red: 300, black: 300 }, turn = "red", colors = {};
  const boardDiv = document.getElementById("board");
  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const modalActions = document.getElementById("modalActions");
  const chatLogDiv = document.getElementById("chatLog");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");

  for (let i = 0; i < 90; i++) {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.onclick = () => onCellClick(i);
    boardDiv.appendChild(cell);
  }

  sendChatBtn.onclick = sendChat;
  chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendChat(); } });

  setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: "ping_check", time: Date.now() }));
  }, 20000);

  setInterval(() => { fetch("/", { method: "GET", cache: "no-cache" }); }, 120000);

  function connect() {
    playerName = document.getElementById("player").value;
    if (!playerName) { alert("Vui l√≤ng nh·∫≠p t√™n"); return; }

    const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const wsHost = window.location.host;
    ws = new WebSocket(`${wsProtocol}//${wsHost}/ws`);

    ws.onopen = () => {
      document.body.classList.add('in-lobby');
      ws.send(JSON.stringify({ type: "join_lobby", player: playerName }));
      document.getElementById("loginView").style.display = "none";
      document.getElementById("lobbyView").style.display = "block";
      document.getElementById("lobbyPlayerName").textContent = playerName;
    };

    ws.onmessage = handleMessage;
    ws.onclose = () => {
      log("‚ö†Ô∏è M·∫•t k·∫øt n·ªëi. Th·ª≠ k·∫øt n·ªëi l·∫°i sau 3 gi√¢y...");
      setTimeout(reconnect, 3000);
    };
  }

  function reconnect() {
    const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const wsHost = window.location.host;
    ws = new WebSocket(`${wsProtocol}//${wsHost}/ws`);
    ws.onopen = () => { ws.send(JSON.stringify({ type: "rejoin", player: playerName })); log("üîÑ ƒê√£ k·∫øt n·ªëi l·∫°i m√°y ch·ªß."); };
    ws.onmessage = handleMessage;
  }

  function handleMessage(e) {
    const msg = JSON.parse(e.data);
    switch (msg.type) {
      case "lobby_update": updateLobby(msg.players); break;
      case "challenge_received": showInvitation(msg.from_player); break;
      case "game_start":
        myColor = msg.color;
        document.getElementById("lobbyView").style.display = "none";
        document.getElementById("gameView").style.display = "block";
        modalOverlay.style.display = "none";
        boardDiv.classList.toggle("board--flipped", myColor === "black");
        log(`Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu. B·∫°n l√† ${myColor}. ƒê·ªëi th·ªß: ${msg.opponent}`);
        chatLogDiv.innerHTML = "";
        addChatMessage("H·ªá th·ªëng", "Chat ƒë√£ k·∫øt n·ªëi!");
        break;
      case "new_chat_message": addChatMessage(msg.from, msg.text); break;
      case "state": updateBoard(msg.state.board); turn = msg.turn; clocks = msg.clocks; colors = msg.colors; updateTurn(); updateClocks(); break;
      case "clock_update": clocks = msg.clocks; updateClocks(); break;
      case "game_over": showGameOver(msg.winner_name, msg.reason); break;
      case "rematch_offered": log(`üì£ ${msg.from} mu·ªën ch∆°i l·∫°i.`); break;
      case "system": log(`‚ÑπÔ∏è ${msg.text}`); break;
      case "error": log(`‚ö†Ô∏è ${msg.reason}`); break;
    }
  }

  function updateLobby(players) {
    const list = document.getElementById("playerList");
    list.innerHTML = "";
    players.forEach(p => {
      if (p === playerName) return;
      const li = document.createElement("li");
      li.textContent = p;
      const b = document.createElement("button");
      b.textContent = "Th√°ch ƒë·∫•u";
      b.onclick = () => ws.send(JSON.stringify({ type: "challenge", target_player: p }));
      li.appendChild(b);
      list.appendChild(li);
    });
    if (list.innerHTML === "") list.innerHTML = "<li>Kh√¥ng c√≥ ai kh√°c.</li>";
  }

  function challengeBot() { if (ws) ws.send(JSON.stringify({ type: "challenge", target_player: "Bot" })); }

  function showInvitation(from) {
    const inv = document.getElementById("invitations");
    inv.innerHTML += `<div class="invitation" id="inv-from-${from}">
      <span>${from} m·ªùi b·∫°n th√°ch ƒë·∫•u.</span>
      <div>
        <button onclick="acceptChallenge('${from}')">Ch·∫•p nh·∫≠n</button>
        <button onclick="declineChallenge('${from}')">T·ª´ ch·ªëi</button>
      </div></div>`;
  }

  function acceptChallenge(n) { ws.send(JSON.stringify({ type: "challenge_accept", opponent_name: n })); document.getElementById("invitations").innerHTML = ""; }
  function declineChallenge(n) { ws.send(JSON.stringify({ type: "challenge_decline", opponent_name: n })); const el = document.getElementById(`inv-from-${n}`); if (el) el.remove(); }

  function getPieceColor(p) { return ['‰ø•', 'ÂÇå', 'Áõ∏', '‰ªï', 'Â∏•', 'ÁÇÆ', 'ÂÖµ'].includes(p) ? 'red' : 'black'; }

  function updateBoard(b) {
    const cells = document.getElementsByClassName("cell");
    for (let i = 0; i < 90; i++) cells[i].innerHTML = "";
    for (let y = 0; y < 10; y++) for (let x = 0; x < 9; x++) {
      const p = b[y][x];
      if (p) {
        const div = document.createElement("div");
        div.className = "piece " + (getPieceColor(p) === 'red' ? 'piece--red' : 'piece--black');
        div.textContent = p;
        cells[y * 9 + x].appendChild(div);
      }
    }
  }

  function updateTurn() {
    const st = document.getElementById("status");
    const now = turn === "red" ? "ƒê·ªè" : "ƒêen";
    const isMyTurn = myColor === turn;
    st.textContent = isMyTurn ? `üéØ L∆∞·ª£t c·ªßa b·∫°n (${now})` : `‚è≥ L∆∞·ª£t c·ªßa ƒë·ªëi th·ªß (${now})`;
  }

  function fmt(s) { s = Math.max(0, Math.floor(s)); let m = Math.floor(s / 60), x = s % 60; return `${String(m).padStart(2, "0")}:${String(x).padStart(2, "0")}`; }

  function updateClocks() {
    document.getElementById("clock_red").textContent = `üî¥ ƒê·ªè: ${fmt(clocks.red)}`;
    document.getElementById("clock_black").textContent = `‚ö´ ƒêen: ${fmt(clocks.black)}`;
  }

  let selected = null;
  function onCellClick(i) {
    if (!myColor || turn !== myColor) { if (selected) document.getElementsByClassName("cell")[selected.i].firstChild.classList.remove("selected"); selected = null; return; }
    const y = Math.floor(i / 9), x = i % 9, cell = document.getElementsByClassName("cell")[i], pieceEl = cell.querySelector('.piece');
    if (!selected && pieceEl) {
      const pieceColor = pieceEl.classList.contains('piece--red') ? 'red' : 'black';
      if (pieceColor !== myColor) return;
      selected = { x, y, i }; pieceEl.classList.add("selected");
    } else if (selected) {
      if (selected.i === i) { cell.firstChild.classList.remove("selected"); selected = null; return; }
      ws.send(JSON.stringify({ type: "move", move: { from: { x: selected.x, y: selected.y }, to: { x, y } } }));
      const oldCell = document.getElementsByClassName("cell")[selected.i];
      if (oldCell && oldCell.firstChild) oldCell.firstChild.classList.remove("selected");
      selected = null;
    }
  }

  function showGameOver(winner_name, reason) {
    modalOverlay.style.display = "flex";
    modalTitle.textContent = "Tr·∫≠n ƒë·∫•u k·∫øt th√∫c!";
    document.getElementById("modalWinnerName").textContent = `${winner_name} Th·∫Øng!`;
    modalText.textContent = `L√Ω do: ${reason}`;
    const rematchButton = modalActions.querySelector('button:nth-child(1)');
    rematchButton.textContent = "Ch∆°i l·∫°i"; rematchButton.disabled = false;
  }

  function offerRematch() {
    if (ws) ws.send(JSON.stringify({ type: "offer_rematch" }));
    log("ƒê√£ g·ª≠i l·ªùi m·ªùi ch∆°i l·∫°i. ƒêang ch·ªù ƒë·ªëi th·ªß...");
    const rematchButton = modalActions.querySelector('button:nth-child(1)');
    if (rematchButton) { rematchButton.textContent = "ƒêang ch·ªù..."; rematchButton.disabled = true; }
  }

  function leaveGame() {
    if (ws) ws.send(JSON.stringify({ type: "leave_game" }));
    document.getElementById("gameView").style.display = "none";
    document.getElementById("lobbyView").style.display = "block";
    modalOverlay.style.display = "none";
    myColor = null; turn = "red"; selected = null;
    log("ƒê√£ quay v·ªÅ s·∫£nh.");
  }

  function log(t) {
    const el = document.getElementById("log");
    const newEntry = document.createElement("div");
    newEntry.className = "log-entry";
    newEntry.innerHTML = `<span>[${new Date().toLocaleTimeString()}]</span> ${t}`;
    el.prepend(newEntry);
    while (el.childElementCount > 100) el.lastChild.remove();
  }

  function sendChat() {
    const text = chatInput.value;
    if (text.trim() === "" || !ws) return;
    ws.send(JSON.stringify({ type: "chat_message", text }));
    chatInput.value = "";
  }

  function addChatMessage(from, text) {
    const newEntry = document.createElement("div");
    newEntry.className = "chat-message";
    const safeFrom = from.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    newEntry.innerHTML = `<b>${safeFrom}:</b> ${safeText}`;
    chatLogDiv.appendChild(newEntry);
    chatLogDiv.scrollTop = chatLogDiv.scrollHeight;
  }
</script>
</body>
</html>
